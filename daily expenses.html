<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expenses</title>
</head>
<body>
    
    <form onsubmit="Submitexpenses(event)">
        <label for="amount">Amount:</label>
        <input type="number" name="amount" id="amount">

        <label for="des">Description:</label>
        <textarea name="des" id="des"></textarea>
        
        <label for="category">Category:</label>
        <select name="category" id="category">
            <option value="food">Food</option>
            <option value="petrol">Petrol</option>
            <option value="health">Health</option>
        </select>
        <button type="submit">Submit</button>
    </form>
    <button id="rzp-button" onclick="buyPremium()">Buy Premium</button>
    <button onclick="download()" id="downloadexpense" style="display: none;">Download File</button>
    
    
    <div id="text"></div>

    <button id="leader" style="display: none;" onclick="displayLeaderBoard()">Leader Board</button>
    <h2>Expenses</h2>
    
    <ul id="ul1"></ul>

    <h2 id="leadhead" style="display: none;">Leader Board</h2>
    <ul id="ul2"></ul>

    
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script>


        document.addEventListener('DOMContentLoaded', (event) => {
            const token = localStorage.getItem('token');
            
            if (parseJwt(token).ispremium) {
                document.getElementById('rzp-button').style.display = 'none'
                document.getElementById('text').innerHTML = 'You are a Premium User now';
                document.getElementById('leader').style.display = 'block'
                document.getElementById('downloadexpense').style.display = 'block'
            }
    
            axios.get('http://localhost:3000/user/expense', { headers: { 'authorization': token } })
                .then(res => {
                    for (i = 0; i < res.data.length; i++) {
                        showOnScreen(res.data[i]);
                    }
                })
                .catch(err => {
                    console.log(err);
                });
        });
        
        //Submit expense
        function Submitexpenses(event) {
            event.preventDefault();
    
            const amount = document.getElementById('amount').value;
            const des = document.getElementById('des').value;
            const category = document.getElementById('category').value;
            const userid = localStorage.getItem('token');
    
            axios.post('http://localhost:3000/user/expense', {
                amount: amount,
                des: des,
                category: category,
                userid: userid
            })
            .then(res => {
                showOnScreen(res.data.newExpense);
            })
            .catch(err => console.log(err));
        }
    
        function showOnScreen(x) {
            const ul = document.getElementById('ul1');
    
            const li = document.createElement('li');
            li.id = `li${x.id}`;
    
            const litext = document.createTextNode(`${x.amount} - ${x.category} - ${x.des}`);
    
            const button = document.createElement('button');
            button.textContent = 'Delete';
            button.onclick = () => {
                ul.removeChild(li);
                const userid = localStorage.getItem('token');
                deleteExpense(x.id,x.amount,userid);
            };
    
            li.appendChild(litext);
            li.appendChild(button);
            ul.appendChild(li);
        }
    
        function deleteExpense(x,y,z) {
            //console.log(y)
            axios.delete(`http://localhost:3000/user/expense/${x}`,{
                params:{y,z}
            })
                .then(res => {
                    console.log('Expense deleted');
                })
                .catch(err => console.log(err));
        }
    
        async function buyPremium() {
            const token = localStorage.getItem('token');
            try {
                const response = await axios.get('http://localhost:3000/purchase/premium', {
                    headers: { 'authorization': token }
                });
    
                var options = {
                    "key": response.data.key_id,
                    "order_id": response.data.order.id,
                    "handler": async function (response) {
                        try {
                            const result = await axios.post('http://localhost:3000/purchase/updateTransactionStatus', {
                                order_id: options.order_id,
                                payment_id: response.razorpay_payment_id,
                            },
                            { headers: { 'authorization': token } }).then(
                                res => {
                                    localStorage.setItem('token', res.data.newToken);
                                }
                            );
    
                            alert('You are a Premium User now');
                            document.getElementById('rzp-button').style.display = 'none'
                            document.getElementById('text').innerHTML = 'You are a Premium User now';
                            document.getElementById('leader').style.display = 'block'
                            document.getElementById('downloadexpense').style.display = 'block'
                        } 
                        catch (error) {
                            console.log(error);
                            alert('Transaction failed. Please try again.');
                        }
                    },
                };
    
                var rzp1 = new Razorpay(options);
                rzp1.open();

            } 
            catch (error) {
                console.log(error);
                alert('Something went wrong. Please try again.');
            }
        }
    
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
    
            return JSON.parse(jsonPayload);
        }


        function displayLeaderBoard(){
            axios.get('http://localhost:3000/purchase/leaderboard')
                .then(res => {
                    //console.log(res.data.leaderBoardDetails)

                    document.getElementById('leadhead').style.display='block'
                    res.data.leaderBoardDetails.forEach(element => {
                        showOnScreenLeadBoard(element)
                    });
                })
        }
        function showOnScreenLeadBoard(x){
            const ul=document.getElementById('ul2')

            const oldli=document.getElementById(`li${x.id}`)

            if (oldli && ul.contains(oldli)){
                ul.removeChild(oldli)
            }

            const li = document.createElement('li');
            li.id = `li${x.id}`;

            const total=x.totalamount||0
    
            const litext = document.createTextNode(`name:${x.name} ---total amount: ${total}`);
    
            li.appendChild(litext);
            ul.appendChild(li);

        }

        function download(){
            const token=localStorage.getItem('token');
            axios.get('http://localhost:3000/user/download', { headers: {"Authorization" : token} })
            .then((response) => {
                if(response.status === 201){

                    var a = document.createElement("a");
                    a.href = response.data.fileUrl;
                    a.download = 'myexpense.csv';
                    a.click();

                } else {
                    throw new Error(response.data.message)
                }
                
            })
            .catch((err) => {
                console.log(`error in download ${err}`)
            });
        }

    </script>
    
    
</body>
</html>